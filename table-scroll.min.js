/*!
table-scroll plugin for JQuery
Version 0.5.0
Copyright (C) 2016 Tom Phane
Licensed under the GNU Affero GPL v.3 or, at the distributor's discretion, a later version.
See http://www.gnu.org/licenses#AGPL.
*/
(function($,window){var b="_sg_index_";var a="_sg_adj_";$.widget("custom.table_scroll",{version:"0.5.0",options:{fixedRowsTop:null,fixedRowsBottom:null,fixedColumnsLeft:0,fixedColumnsRight:0,scrollableRows:"auto",scrollableColumns:"auto",scrollX:0,scrollY:0,overflowY:"auto",overflowX:"auto",visibleHeight:"auto",visibleWidth:"auto"},_create:function(){this.$table=this.widget();this._columnsCount=-1;this._currentTouch=null;this._ensureSettings();this.startFrom=0;this._setActualCellIndexes();this._yInitScroll();this._yUpdateRowsVisibility();this._xInitScroll();this._xUpdateColumnsVisibility();this._yUpdateScrollHeights();this.$table.on("mousewheel",$.proxy(this._tableMouseWheel,this));this.$table.on("DOMMouseScroll",$.proxy(this._tableMouseWheel,this));this.$table.on("touchstart",$.proxy(this._touchStart,this));this.$table.on("touchmove",$.proxy(this._touchMove,this));this.$table.on("touchend",$.proxy(this._touchEnd,this));$(window).on("resize",$.proxy(this._reSize,this));this._xMoveScroll(this.options.scrollX);this._yMoveScroll(this.options.scrollY);this._yUpdateRowsVisibility();this._xUpdateColumnsVisibility()},_ensureSettings:function(){var c=this.$table[0];if(this.options.fixedRowsTop===null){if(c.tHead){this.options.fixedRowsTop=c.tHead.rows.length}else{this.options.fixedRowsTop=1}}if(this.options.fixedRowsBottom===null){if(c.tFoot){this.options.fixedRowsBottom=c.tFoot.rows.length}else{this.options.fixedRowsBottom=0}}if(this.options.scrollableRows=="auto"){}if(this.options.scrollableColumns=="auto"){}},_xGetNumberOfColumns:function(){if(this._columnsCount!=-1){return this._columnsCount}this._columnsCount=Math.max.apply(null,$(this.$table[0].rows).map(function(){return this.cells.length}).get());if($(".sg-v-scroll-cell",this.$table).length>0){this._columnsCount-=1}return this._columnsCount},_xNumberOfScrollableColumns:function(){var c=this._xGetNumberOfColumns()-this.options.fixedColumnsLeft-this.options.fixedColumnsRight;if(c<1){return 1}return c},_xScrollWidth:function(){var c=this._xGetNumberOfColumns()-this.options.fixedColumnsLeft-this.options.fixedColumnsRight;if(c>this.options.scrollableColumns){return this.options.scrollableColumns}if(c<1){return 1}return c},_xScrollNeeded:function(){var c=this._xGetNumberOfColumns()-this.options.fixedColumnsLeft-this.options.fixedColumnsRight;return c>this.options.scrollableColumns},_xInitScroll:function(){if(this._xGetNumberOfColumns()<(this.options.fixedColumnsLeft+this.options.fixedColumnsRight)){return}if(this._xScrollNeeded()||this.options.overflowX=="scroll"){var f=this.$table[0];var h=f.insertRow(f.rows.length);if(this.options.fixedColumnsLeft>0){var d=$(h.insertCell(0));d.attr("colspan",this.options.fixedColumnsLeft)}var g=$(h.insertCell(1));g.attr("colspan",this._xScrollWidth());g.addClass("sg-x-scroll-cell");var e=$('<div class="sg-h-scroll-container"></div>');e.css("overflow-x","scroll");e.css("margin-right","-20000px");e.width(g.width());var c=$('<div style="height: 1px;"></div>');c.width((this._xNumberOfScrollableColumns()/this._xScrollWidth())*g.width());c.appendTo(e);e.appendTo(g);e.scroll($.proxy(this._xUpdateColumnsVisibility,this));if(this.options.fixedColumnsRight>0){var d=$(h.insertCell(2));d.attr("colspan",this.options.fixedColumnsRight+($(".sg-v-scroll-cell",this.$table).length>0?1:0))}}},_xCurrentRelativeScrollLeft:function(){var c=$(".sg-h-scroll-container",this.$table);return c.scrollLeft()/c.width()},_xScrollDelta:function(){var c=$(".sg-h-scroll-container",this.$table);return $("div",c).width()-c.width()},_xScrollableColumnsCount:function(){return this._xNumberOfScrollableColumns()-this._xScrollWidth()},_xColumnScrollStep:function(){if(this._xScrollableColumnsCount()===0){return 0}return this._xScrollDelta()/this._xScrollableColumnsCount()},_xMoveScroll:function(c){c=Math.min(this._xScrollableColumnsCount(),c);c=Math.max(c,0);c=this._xColumnScrollStep()*c;var d=$(".sg-h-scroll-container",this.$table);if(d.scrollLeft()!=c){d.scrollLeft(c)}},_setColumnVisibility:function(f,d,c,e){var l=this.$table[0].rows;for(var i=c;i<e;i++){var k=l[i];for(var g=0;g<k.cells.length;g++){var j=k.cells[g];var h=j[b];if(h==f){if(!j.colSpan||j.colSpan==1){if(d&&j.style.display=="none"){j.style.display=""}if(!d&&j.style.display!="none"){j.style.display="none"}}}}}},_xFirstVisibleColumnWidth:function(){var e=this.$table[0];for(var d=this.options.fixedRowsTop;d<e.rows.length-this.options.fixedRowsBottom-$(".sg-h-scroll-container",this.$table).length;d++){if($(e.rows[d]).css("display")!="none"){for(var c=this.options.fixedColumnsLeft;c<this._xGetNumberOfColumns()-this.options.fixedColumnsRight;c++){if($(e.rows[d].cells[c]).css("display")!="none"){return $(e.rows[d].cells[c]).width()}}}}return 0},_xLastVisibleColumnWidth:function(){var e=this.$table[0];for(var d=this.options.fixedRowsTop;d<e.rows.length-this.options.fixedRowsBottom-$(".sg-h-scroll-container",this.$table).length;d++){if($(e.rows[d]).css("display")!="none"){for(var c=this._xGetNumberOfColumns()-this.options.fixedColumnsRight-1;c>=this.options.fixedColumnsLeft;c--){if($(e.rows[d].cells[c]).css("display")!="none"){return $(e.rows[d].cells[c]).width()}}}}return 0},_xUpdateColumnsVisibility:function(){if(!this._xScrollNeeded()){return}var g=$(".sg-h-scroll-container",this.$table);var e=Math.floor(g.scrollLeft()/this._xColumnScrollStep());var c=this._xCurrentRelativeScrollLeft();for(var d=this.options.fixedColumnsLeft;d<this._xGetNumberOfColumns()-this.options.fixedColumnsRight;d++){var f=false;if(d>=this.options.fixedColumnsLeft+e&&d<this.options.fixedColumnsLeft+e+this.options.scrollableColumns){f=true}this._setColumnVisibility(d,f,0,this.$table[0].rows.length-1)}this._xUpdateScrollWidths()},_xUpdateScrollWidths:function(){var e=$(".sg-h-scroll-container",this.$table);var d=e.closest("td");e.width(d.width());var c=$("div",e);c.width((this._xNumberOfScrollableColumns()/this._xScrollWidth())*d.width())},_yScrollHeight:function(){var d=this.$table[0];var c=d.rows.length-this.options.fixedRowsTop-this.options.fixedRowsBottom;if($(".sg-h-scroll-container",this.$table).length>0){c--}if(c>this.options.scrollableRows){return this.options.scrollableRows}if(c<1){return 1}return c},_yNumberOfScrollableRows:function(){var d=this.$table[0];var c=d.rows.length-this.options.fixedRowsTop-this.options.fixedRowsBottom;if($(".sg-h-scroll-container",this.$table).length>0){c--}if(c<1){return 1}return c},_yScrollNeeded:function(){var d=this.$table[0];var c=d.rows.length-this.options.fixedRowsTop-this.options.fixedRowsBottom;if($(".sg-h-scroll-container",this.$table).length>0){c--}return c>this.options.scrollableRows},_yInitScroll:function(){var h=this.$table[0];if(h.rows.length<(this.options.fixedRowsTop+this.options.fixedRowsBottom)){return}if(this._yScrollNeeded()||this.options.overflowY=="scroll"){var f=$(h.rows[0].insertCell(h.rows[0].cells.length));f.attr("rowspan",this.options.fixedRowsTop);var i=$(h.rows[this.options.fixedRowsTop+this.startFrom].insertCell(h.rows[this.options.fixedRowsTop+this.startFrom].cells.length));i.attr("rowspan",this._yScrollHeight());i.attr("width","1px");i.addClass("sg-v-scroll-cell");var g=$('<div class="sg-v-scroll-container"></div>');g.css("overflow-y","scroll");g.height(i.height());var c=$('<div style="width: 1px;"></div>');c.height((this._yNumberOfScrollableRows()/this._yScrollHeight())*i.height());c.appendTo(g);g.appendTo(i);this._attachToEndScrolling(g,$.proxy(this._yUpdateRowsVisibility,this));if(this.options.fixedRowsBottom!==0){var e=h.rows[this._yNumberOfScrollableRows()+this.options.fixedRowsTop];var d=$(e.insertCell(e.cells.length));d.attr("rowspan",this.options.fixedRowsBottom)}}},_yCurrentRelativeScrollTop:function(){var c=$(".sg-v-scroll-container",this.$table);return c.scrollTop()/c.height()},_yMoveScrollToRightRow:function(g){var f=$(".sg-v-scroll-cell",this.$table).closest("tr")[0];var d=this.$table[0].rows[this.options.fixedRowsTop+this.startFrom];var i=$(".sg-v-scroll-container",this.$table);var c=$("div",i);if(f!=d){var h=$(d.insertCell(d.cells.length));h.attr("rowspan",this._yScrollHeight());h.addClass("sg-v-scroll-cell");h.attr("width","1px");var e=$(".sg-v-scroll-container",$(f));e.height(0);e.appendTo(h);f.deleteCell(f.cells.length-1);i.height(h.height());c.height((this._yNumberOfScrollableRows()/this._yScrollHeight())*h.height());i.scrollTop(g*i.height());i[0]}},_yScrollDelta:function(){var c=$(".sg-v-scroll-container",this.$table);return $("div",c).height()-c.height()},_yScrollableRowsCount:function(){return this._yNumberOfScrollableRows()-this._yScrollHeight()},_yRowScrollStep:function(){if(this._yScrollableRowsCount()===0){return 0}return this._yScrollDelta()/this._yScrollableRowsCount()},_yMoveScroll:function(c){c=Math.min(this._yScrollableRowsCount(),c);c=Math.max(c,0);var d=this._yRowScrollStep();c=d*c;var e=$(".sg-v-scroll-container",this.$table);if(e.scrollTop()!=c){e.scrollTop(c+d/2)}},_yUpdateScrollHeights:function(){var d=$(".sg-v-scroll-container",this.$table);var e=d.closest("td");d.hide();d.height(e.height());var c=$("div",d);c.height((this._yNumberOfScrollableRows()/this._yScrollHeight())*e.height());topContainer.show()},_yFirstVisibleRowHeight:function(){var d=this.$table[0];for(var c=this.options.fixedRowsTop;c<d.rows.length-this.options.fixedRowsBottom-$(".sg-h-scroll-container",this.$table).length;c++){if($(d.rows[c]).css("display")!="none"){return $(d.rows[c]).height()}}return 0},_yLastVisibleRowHeight:function(){var d=this.$table[0];for(var c=d.rows.length-this.options.fixedRowsBottom-$(".sg-h-scroll-container",this.$table).length-1;c>=this.options.fixedRowsTop;c--){if($(d.rows[c]).css("display")!="none"){return $(d.rows[c]).height()}}return 0},_yUpdateRowsVisibility:function(){if(!this._yScrollNeeded()){return}var d=$(".sg-v-scroll-container",this.$table);var f=Math.floor(d.scrollTop()/this._yRowScrollStep());var e=this._yCurrentRelativeScrollTop();var g=this.$table[0];for(var c=this.options.fixedRowsTop;c<g.rows.length-this.options.fixedRowsBottom-$(".sg-h-scroll-container",this.$table).length;c++){if(c>=this.options.fixedRowsTop+f&&c<this.options.fixedRowsTop+f+this.options.scrollableRows){$(g.rows[c]).show()}else{$(g.rows[c]).hide()}}if(this.startFrom!=f){this.startFrom=f;this._yMoveScrollToRightRow(e)}},_attachToEndScrolling:function(c,d){c.scroll(function(){clearTimeout(c.data("scrollTimer"));$.data(this,"scrollTimer",setTimeout(function(){d.apply(this)},300))})},_tableMouseWheel:function(e){var c=false;var h=false;var d=e.originalEvent;if(d.wheelDelta){if(d.wheelDelta>=120){c=true}else{if(d.wheelDelta<=-120){h=true}}}if(d.detail){if(d.detail==-3){c=true}else{if(d.detail==3){h=true}}}var f=$(".sg-v-scroll-container",this.$table);var g=0;if(c){g=this._yRowScrollStep()+1}if(h){g=-this._yRowScrollStep()-1}if(g!==0){f.scrollTop(f.scrollTop()-g)}e.preventDefault()},_touchStart:function(c){if(c.originalEvent.touches&&c.originalEvent.touches.length==1){var d=c.originalEvent.touches[0]||c.originalEvent.changedTouches[0];this._currentTouch={X:d.pageX,Y:d.pageY};c.preventDefault();c.stopPropagation()}},_touchMove:function(d){if(d.originalEvent.touches&&d.originalEvent.touches.length==1&&this._currentTouch!==null){var h=d.originalEvent.touches[0]||d.originalEvent.changedTouches[0];var k={X:h.pageX,Y:h.pageY};var g=this._currentTouch.X-k.X;var f=this._currentTouch.Y-k.Y;var e=$(".sg-v-scroll-container",this.$table);if(f>0){var j=this._yFirstVisibleRowHeight();if(j!==0&&f>j){e.scrollTop(e.scrollTop()+(this._yRowScrollStep()+1));this._currentTouch.Y-=j;this._yUpdateRowsVisibility()}}else{var j=this._yLastVisibleRowHeight();if(j!==0&&f<-1*j){e.scrollTop(e.scrollTop()-(this._yRowScrollStep()+1));this._currentTouch.Y+=j;this._yUpdateRowsVisibility()}}var i=$(".sg-h-scroll-container",this.$table);if(g>0){var c=this._xFirstVisibleColumnWidth();if(c!==0&&g>c){i.scrollLeft(i.scrollLeft()+(this._xColumnScrollStep()+1));this._currentTouch.X-=j}}else{var c=this._xLastVisibleColumnWidth();if(c!==0&&g<-1*c){i.scrollLeft(i.scrollLeft()-(this._xColumnScrollStep()+1));this._currentTouch.X+=c}}d.preventDefault();d.stopPropagation()}},_touchEnd:function(c){this._currentTouch=null},_reSize:function(d){var c=1},_setActualCellIndexes:function(){var p=this.$table[0].rows;for(var k=0;k<p.length;k++){var o=p[k];var h=$(o)[0][a];if(!h){h=[]}for(var j=0;j<o.cells.length;j++){var q=j-1;if(j>0){var f=$(o.cells[j-1]);q=f[0][b];if(f.attr("colspan")){q+=this._getColSpan(f)-1}}var l=$(o.cells[j]);var c=q+1;for(var g=0;g<h.length;g++){if(h[g].index<=c){c+=h[g].adjustment;h[g].adjustment=0}}l[0][b]=c;if(l.attr("rowspan")>1){var m=l.attr("rowspan");for(var e=k+1;e<k+m&&e<p.length;e++){var n=$(p[e]);var d=n[0][a];if(!d){d=[]}d.push({index:c,adjustment:this._getColSpan(l)});n[0][a]=d}}}}},_getColSpan:function(c){if(c.data("scroll-span")){return c.data("scroll-span")}if(c.attr("colspan")){return c.attr("colspan")*1}return 1}})})(jQuery,window);